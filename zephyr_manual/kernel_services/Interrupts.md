###中断

中断服务例程（ISR）是响应硬件或软件中断而异步执行的功能。 ISR通常会抢占当前线程的执行，从而允许响应以非常低的开销发生。 所有ISR工作完成后，线程执行才会恢复。

* 概念

    * 多级中断处理
    
    * 防止中断
    
    * 卸载ISR工作
    
* Implementation

    * Defining a regular ISR
    
    * Defining a ‘direct’ ISR
    
    * Implementation Details
    
* Suggested Uses

* Configuration Options

* API Reference

#### 概念

可以根据底层硬件施加的约束来定义任意数量的ISR。

ISR具有以下关键属性：

* 触发ISR 的中断请求（IRQ）信号。

* 与IRQ相关的优先级。

* 一个中断处理函数，用于处理中断。

* 传递给该函数的参数值。

IDT或向量表用于将给定的中断源与给定的ISR相关联。 在任何给定时间，只有一个ISR可以与特定的IRQ相关联。

多个ISR可以使用相同的功能来处理中断，允许单个功能为产生多种类型中断的设备提供服务，或者为多个设备（通常是相同类型）提供服务。 传递给ISR函数的参数值允许函数确定已发出信号的中断。

内核为所有未使用的IDT条目提供默认ISR。 如果发出意外中断信号，则此ISR会生成致命系统错误。

内核支持中断嵌套。 如果发出更高优先级的中断信号，则允许在执行中期抢占ISR。 一旦较高优先级的ISR完成其处理，较低优先级的ISR恢复执行。

ISR的中断处理程序函数在内核的中断上下文中执行。 此上下文具有自己的专用堆栈区域（或者，在某些体系结构上，堆栈区域）。 如果启用了中断嵌套支持，则中断上下文堆栈的大小必须能够处理多个并发ISR的执行。

*重要：
许多内核API只能由线程使用，而不能由ISR使用。 在线程和ISR都可以调用例程的情况下，内核提供k_is_in_isr（）API以允许例程根据它是作为线程的一部分执行还是作为ISR的一部分来改变其行为。*

#### 多级中断处理

硬件平台可以支持比通过使用一个或多个嵌套中断控制器本机提供的更多中断线。 硬件中断源被组合成一行，然后路由到父控制器。

如果支持嵌套中断控制器，则应将CONFIG_MULTI_LEVEL_INTERRUPTS设置为1，并根据硬件体系结构配置CONFIG_2ND_LEVEL_INTERRUPTS和CONFIG_3RD_LEVEL_INTERRUPTS。

分配一个唯一的32位中断号，其中嵌入了信息以选择和调用正确的中断服务程序（ISR）。 每个中断级别在此32位数字内给出一个字节，使用此拱形提供最多四个中断级别的支持，如下图所示和解释：

	          9             2   0
	    _ _ _ _ _ _ _ _ _ _ _ _ _         (LEVEL 1)
	  5       |         A   |
	_ _ _ _ _ _ _         _ _ _ _ _ _ _   (LEVEL 2)
	  |   C                       B
	_ _ _ _ _ _ _                         (LEVEL 3)
	        D

此处显示了三个中断级别。

* ' - '表示中断线，编号从0开始（最右边）。

* LEVEL 1有12条中断线，两条线（2和9）连接到嵌套控制器，一条设备'A'连接到第4线。

* 其中一个LEVEL 2控制器具有连接到LEVEL 3嵌套控制器的中断线5和连接到第3线上的一个设备“C”。

* 另一个LEVEL 2控制器没有嵌套控制器，但在第2行有一个设备'B'。

* LEVEL 3控制器在第2行有一个设备'D'。

以下是为每个硬件中断生成唯一中断号的方法。 让我们考虑上面显示的四个中断为A，B，C和D：

	A -> 0x00000004
	B -> 0x00000302
	C -> 0x00000409
	D -> 0x00030609

*注：
LEVEL 2及其后的位位置偏移1，因为0表示该级别不存在中断号。 对于我们的示例，LEVEL 3控制器在线路2上具有设备D，连接到LEVEL 2控制器的线路5，该线路连接到LEVEL 1控制器的线路9（2  - > 5  - > 9）。 由于LEVEL 2及以后的编码偏移，设备D的编号为0x00030609。*

























